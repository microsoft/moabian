#!/bin/bash
# vim:filetype=sh:

# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

set -euo pipefail
require() { hash "$@" || exit 127; }
println() { printf '%s\n' "$*"; }
die()     { ret=$?; printf "%s\n" "$@" >&2; exit "$ret"; }
[[ $EUID -eq 0 ]] || die "$0 run as root. Try again with sudo"

hat_en=20
boot_en=5
hat_reset=6

# Using gpio readall
#define BOOT_EN   RPI_BPLUS_GPIO_J8_29      BCM 5 / G21 (IN default 0)
#define HAT_EN    RPI_BPLUS_GPIO_J8_38      BCM 20 / G28 (IN default 0)
#define HAT_RESET RPI_BPLUS_GPIO_J8_31      BCM 6 /GPIO 22 (IN default 0)

echo "Enabling direction"
sudo raspi-gpio set 20 op
sudo raspi-gpio set 5 op
sudo raspi-gpio set 6 op

echo "Putting firmware into upload mode..."
sudo raspi-gpio set 20 dh
sudo raspi-gpio set 5 dh
sudo raspi-gpio set 6 dh
sleep 1
sudo raspi-gpio set 6 dl

# echo "Uploading firmware now"
mcumgr --conntype=serial --connstring=/dev/ttyAMA1,baud=115200 image upload $1

# echo "Done. Resetting firmware"
sudo raspi-gpio set 5 dl
sudo raspi-gpio set 6 dh
sleep 1
sudo raspi-gpio set 6 dl
